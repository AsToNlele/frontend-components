"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0}),require("./_commonjsHelpers-32c5d30b.js");var sourceFormRenderer=require("./index-7fe7c2c5.js"),objectWithoutProperties=require("./objectWithoutProperties-9e2b4e81.js"),slicedToArray=require("./slicedToArray-359307e9.js"),defineProperty=require("./defineProperty-cf06dcaa.js"),React=require("react"),React__default=_interopDefault(React),Button_js=require("@patternfly/react-core/dist/js/components/Button/Button.js"),PropTypes=_interopDefault(require("prop-types")),isEmpty=_interopDefault(require("lodash/isEmpty")),reactIntl=require("react-intl"),Wizard_js=require("@patternfly/react-core/dist/js/components/Wizard/Wizard.js");require("@data-driven-forms/react-form-renderer/dist/cjs/form-renderer"),require("@data-driven-forms/react-form-renderer/dist/cjs/component-types"),require("@data-driven-forms/react-form-renderer/dist/cjs/validator-types"),require("@data-driven-forms/react-form-renderer/dist/cjs/validator-mapper"),require("@data-driven-forms/pf4-component-mapper/dist/cjs/form-template"),require("@data-driven-forms/pf4-component-mapper/dist/cjs/component-mapper"),require("./toConsumableArray-fe9ed082.js"),require("@patternfly/react-core/dist/js/components/Text/TextContent.js"),require("@patternfly/react-core/dist/js/components/Text/TextListItem.js"),require("@patternfly/react-core/dist/js/components/Text/TextList.js"),require("@patternfly/react-core/dist/js/components/Alert/Alert.js"),require("lodash/get"),require("@patternfly/react-core/dist/js/components/Form/FormHelperText.js"),require("@patternfly/react-icons/dist/js/icons/question-circle-icon"),require("@patternfly/react-core/dist/js/components/Popover/Popover.js");var Text_js=require("@patternfly/react-core/dist/js/components/Text/Text.js"),hardcodedSchemas=require("./hardcodedSchemas-11027244.js");require("@patternfly/react-core/dist/js/components/ClipboardCopy/ClipboardCopy.js"),require("@data-driven-forms/react-form-renderer/dist/cjs/use-form-api"),require("@redhat-cloud-services/frontend-components-utilities/files/cjs/interceptors");var constants=require("./constants.js"),index=require("./index-1dfedd03.js");require("./schemaBuilder-3e86f68c.js"),require("./SourceWizardSummary.js"),require("@patternfly/react-core/dist/js/components/Card/Card.js"),require("@patternfly/react-core/dist/js/components/Card/CardBody.js"),require("@patternfly/react-core/dist/js/components/Form/FormGroup.js"),require("@patternfly/react-core/dist/js/layouts/Grid/Grid.js"),require("@patternfly/react-core/dist/js/layouts/Grid/GridItem.js"),require("@patternfly/react-core/dist/js/layouts/Bullseye/Bullseye.js"),require("@patternfly/react-core/dist/js/components/Card/CardTitle.js"),require("@data-driven-forms/react-form-renderer/dist/cjs/use-field-api"),require("./CardSelect.js"),require("@patternfly/react-core/dist/js/components/Radio/Radio.js"),require("./AuthSelect.js"),require("@data-driven-forms/pf4-component-mapper/dist/cjs/select"),require("./asyncToGenerator-a32dc547.js"),require("awesome-debounce-promise");var SourceAddSchema=require("./SourceAddSchema.js");require("./handleError.js"),require("@patternfly/react-core/dist/js/components/Spinner/Spinner.js"),require("@data-driven-forms/react-form-renderer/dist/cjs/form-spy"),require("./validated.js"),require("@patternfly/react-core/dist/js/components/EmptyState/EmptyState.js"),require("@patternfly/react-core/dist/js/components/EmptyState/EmptyStateSecondaryActions.js"),require("@patternfly/react-core/dist/js/components/EmptyState/EmptyStateIcon.js"),require("@patternfly/react-core/dist/js/components/Title/Title.js");var LoadingStep=require("./LoadingStep.js"),filterApps=require("./filterApps.js"),filterTypes=require("./filterTypes.js"),reactRouterDom=require("react-router-dom");require("@patternfly/react-core/dist/js/components/EmptyState/EmptyStateBody.js"),require("@patternfly/react-icons/dist/js/icons/check-circle-icon");var FinishedStep=require("./FinishedStep.js");require("@patternfly/react-icons/dist/js/icons/exclamation-circle-icon");var ErroredStep=require("./ErroredStep.js");require("@patternfly/react-icons/dist/js/icons/wrench-icon");var TimeoutStep=require("./TimeoutStep.js");require("./costManagementAuthentication.js"),require("./getApplicationStatus.js");var createSource=require("./createSource.js");require("@patternfly/react-core/dist/js/components/Modal/Modal.js"),require("@patternfly/react-icons/dist/js/icons/exclamation-triangle-icon");var CloseModal=require("./CloseModal.js");function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);r&&(s=s.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,s)}return t}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach((function(r){defineProperty._defineProperty(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}var initialValues={schema:{},sourceTypes:[],isLoading:!0},reducer=function reducer(e,r){var t=r.type,s=r.sourceTypes,o=r.applicationTypes,a=r.container,i=r.disableAppSelection,n=r.intl;switch(t){case"loaded":return _objectSpread({},e,{schema:SourceAddSchema.default(s.filter(filterTypes.default),o.filter(filterApps.default),i,a,n),isLoading:!1,sourceTypes:s})}},SourceAddModal=function SourceAddModal(e){var r=e.sourceTypes,t=e.applicationTypes,s=e.disableAppSelection,o=e.isCancelling,a=e.onCancel,i=e.values,n=e.onSubmit,c=React.useReducer(reducer,initialValues),u=slicedToArray._slicedToArray(c,2),d=u[0],p=d.schema,l=d.sourceTypes,f=d.isLoading,y=u[1],m=React.useRef(!1),S=React.useRef(document.createElement("div")),T=reactIntl.useIntl();return React.useEffect((function(){m.current=!0;var e=[];return r||e.push(index.doLoadSourceTypes()),t||e.push(index.doLoadApplicationTypes()),Promise.all(e).then((function(e){var o=e.find((function(e){return e.hasOwnProperty("sourceTypes")})),a=e.find((function(e){return e.hasOwnProperty("applicationTypes")}));m.current&&y({type:"loaded",sourceTypes:r||o.sourceTypes,applicationTypes:t||a.applicationTypes,disableAppSelection:s,container:S.current,intl:T})})),function(){m.current=!1}}),[]),React.useEffect((function(){S.current.hidden=o}),[o]),f?React__default.createElement(Wizard_js.Wizard,{isOpen:!0,onClose:a,title:hardcodedSchemas.WIZARD_TITLE,description:hardcodedSchemas.WIZARD_DESCRIPTION,steps:[{name:"Loading",component:React__default.createElement(LoadingStep.default,{onClose:function onClose(){return a()}}),isFinishedStep:!0}]}):React__default.createElement(sourceFormRenderer.SourcesFormRenderer,{initialValues:i,schema:p,onSubmit:function onSubmit(e){return n(e,l)},onCancel:a})};SourceAddModal.propTypes={onCancel:PropTypes.func.isRequired,onSubmit:PropTypes.func.isRequired,sourceTypes:PropTypes.arrayOf(PropTypes.shape({id:PropTypes.string.isRequired,name:PropTypes.string.isRequired,product_name:PropTypes.string.isRequired,schema:PropTypes.shape({authentication:PropTypes.array,endpoint:PropTypes.object})})),applicationTypes:PropTypes.arrayOf(PropTypes.shape({id:PropTypes.string.isRequired,name:PropTypes.string.isRequired,display_name:PropTypes.string.isRequired})),values:PropTypes.object,disableAppSelection:PropTypes.bool,isCancelling:PropTypes.bool},SourceAddModal.defaultProps={values:{},disableAppSelection:!1};var FinalWizard=function FinalWizard(e){var r,t=e.afterSubmit,s=e.afterError,o=e.isFinished,a=e.isErrored,i=e.successfulMessage,n=e.hideSourcesButton,c=e.returnButtonTitle,u=e.reset,d=e.createdSource,p=void 0===d?{}:d,l=e.tryAgain,f=e.afterSuccess,y=React.useState(),m=slicedToArray._slicedToArray(y,2),S=m[0],T=m[1],j=React.useState(),_=slicedToArray._slicedToArray(j,2),g=_[0],h=_[1],q=reactIntl.useIntl();if(g)r=React__default.createElement(FinishedStep.default,{onClose:t,title:q.formatMessage({id:"wizard.removeSourceSuccessTitle",defaultMessage:"Removing successful"}),successfulMessage:q.formatMessage({id:"wizard.removeSourceSuccessDescription",defaultMessage:"Source was successfully removed."}),hideSourcesButton:n,returnButtonTitle:c,secondaryActions:React__default.createElement(Button_js.Button,{variant:"link",onClick:u},q.formatMessage({id:"wizard.addAnotherSource",defaultMessage:"Add another source"}))});else if(S)r=React__default.createElement(LoadingStep.default,{customText:q.formatMessage({id:"wizard.removingSource",defaultMessage:"Removing source"})});else if(o){var P,b;if("available"===(null===(P=p.applications[0])||void 0===P?void 0:P.availability_status))r=React__default.createElement(FinishedStep.default,{onClose:t,successfulMessage:i,hideSourcesButton:n,returnButtonTitle:c,secondaryActions:React__default.createElement(Button_js.Button,{variant:"link",onClick:u},q.formatMessage({id:"wizard.addAnotherSource",defaultMessage:"Add another source"}))});else if("unavailable"===(null===(b=p.applications[0])||void 0===b?void 0:b.availability_status)){var v;r=React__default.createElement(ErroredStep.default,{onClose:t,secondaryActions:React__default.createElement(Button_js.Button,{variant:"link",onClick:function removeSource(){return T(!0),index.getSourcesApi().removeSource(p.id).then((function(){f&&f(),h(!0)})).catch((function(){return T(!1)}))}},q.formatMessage({id:"wizard.removeSource",defaultMessage:"Remove source"})),Component:function Component(){return React__default.createElement(reactRouterDom.Link,{to:"/sources/edit/".concat(p.id)},React__default.createElement(Button_js.Button,{variant:"primary",className:"pf-u-mt-xl"},q.formatMessage({id:"wizard.editSource",defaultMessage:"Edit source"})))},message:(null===(v=p.applications[0])||void 0===v?void 0:v.availability_status_error)||q.formatMessage({id:"wizard.unknownError",defaultMessage:"Unknown error"}),title:q.formatMessage({id:"wizard.configurationUnsuccessful",defaultMessage:"Configuration unsuccessful"})})}else r=p.applications[0]?React__default.createElement(TimeoutStep.default,{onClose:t,returnButtonTitle:c,secondaryActions:React__default.createElement(Button_js.Button,{variant:"link",onClick:u},q.formatMessage({id:"wizard.addAnotherSource",defaultMessage:"Add another source"}))}):React__default.createElement(FinishedStep.default,{onClose:t,successfulMessage:i,hideSourcesButton:n,returnButtonTitle:c,secondaryActions:React__default.createElement(Button_js.Button,{variant:"link",onClick:u},q.formatMessage({id:"wizard.addAnotherSource",defaultMessage:"Add another source"}))})}else r=a?React__default.createElement(ErroredStep.default,{onClose:s,primaryAction:l,secondaryActions:React__default.createElement(Text_js.Text,{component:"a",target:"_blank",href:"https://access.redhat.com/support/cases/#/case/new/open-case?caseCreate=true",rel:"noopener noreferrer"},q.formatMessage({id:"wizard.openTicket",defaultMessage:"Open a support case"})),returnButtonTitle:q.formatMessage({id:"wizard.retryText",defaultMessage:"Retry"})}):React__default.createElement(LoadingStep.default,{customText:q.formatMessage({id:"wizard.loadingText",defaultMessage:"Validating source credentials"}),onClose:s,cancelTitle:q.formatMessage({id:"wizard.close",defaultMessage:"Close"})});return(React__default.createElement(Wizard_js.Wizard,{isOpen:!0,onClose:o?t:s,title:hardcodedSchemas.WIZARD_TITLE,description:hardcodedSchemas.WIZARD_DESCRIPTION,steps:[{name:"Finish",component:r,isFinishedStep:!0}]}))};function ownKeys$1(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);r&&(s=s.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,s)}return t}function _objectSpread$1(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys$1(Object(t),!0).forEach((function(r){defineProperty._defineProperty(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys$1(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}FinalWizard.propTypes={afterSubmit:PropTypes.func.isRequired,afterError:PropTypes.func.isRequired,isFinished:PropTypes.bool.isRequired,isErrored:PropTypes.bool.isRequired,successfulMessage:PropTypes.node.isRequired,hideSourcesButton:PropTypes.bool,returnButtonTitle:PropTypes.node.isRequired,errorMessage:PropTypes.node,reset:PropTypes.func,createdSource:PropTypes.object,tryAgain:PropTypes.func,afterSuccess:PropTypes.func};var prepareInitialValues=function prepareInitialValues(e){return{isSubmitted:!1,isFinished:!1,isErrored:!1,isCancelling:!1,values:e,createdSource:{},error:void 0}},reducer$1=function reducer(e,r){var t=r.type,s=r.values,o=r.data,a=r.error,i=r.initialValues,n=r.sourceTypes;switch(t){case"reset":return prepareInitialValues(i);case"prepareSubmitState":return _objectSpread$1({},e,{isFinished:!1,isErrored:!1,error:void 0,isSubmitted:!0,values:s,sourceTypes:n});case"setSubmitted":return _objectSpread$1({},e,{isFinished:!0,createdSource:o});case"setErrored":return _objectSpread$1({},e,{isErrored:!0,error:a.toString()});case"onStay":return _objectSpread$1({},e,{isCancelling:!1});case"showCancelModal":return _objectSpread$1({},e,{isCancelling:!0,values:s})}},AddSourceWizard=function AddSourceWizard(e){var r=e.successfulMessage,t=e.isOpen,s=e.sourceTypes,o=e.applicationTypes,a=e.disableAppSelection,i=e.hideSourcesButton,n=e.returnButtonTitle,c=e.initialValues,u=e.onClose,d=e.afterSuccess,p=React.useReducer(reducer$1,prepareInitialValues(c)),l=slicedToArray._slicedToArray(p,2),f=l[0],y=f.isErrored,m=f.isFinished,S=f.isSubmitted,T=f.values,j=f.error,_=f.isCancelling,g=f.createdSource,h=objectWithoutProperties._objectWithoutProperties(f,["isErrored","isFinished","isSubmitted","values","error","isCancelling","createdSource"]),q=l[1],P=function onSubmit(e,r){return q({type:"prepareSubmitState",values:e,sourceTypes:r}),createSource.doCreateSource(e,r,constants.timeoutedApps(o)).then((function(e){d&&d(e),q({type:"setSubmitted",data:e})})).catch((function(e){q({type:"setErrored",error:e})}))};return t?S?React__default.createElement(FinalWizard,{afterSubmit:function afterSubmit(){u(void 0,g),q({type:"reset",initialValues:c})},afterError:function afterError(){return u({})},isFinished:m,isErrored:y,successfulMessage:r,hideSourcesButton:i,returnButtonTitle:n,errorMessage:j,reset:function reset(){return q({type:"reset",initialValues:c})},createdSource:g,tryAgain:function tryAgain(){return P(T,h.sourceTypes)},afterSuccess:d}):React__default.createElement(React__default.Fragment,null,React__default.createElement(CloseModal.default,{isOpen:_,onExit:function onExit(){return u(T)},onStay:function onStay(){return q({type:"onStay"})}}),React__default.createElement(SourceAddModal,{isCancelling:_,values:T,onSubmit:P,onCancel:function onCancelBeforeExit(e){return isEmpty(e)?u({}):q({type:"showCancelModal",values:e})},sourceTypes:s,applicationTypes:o,disableAppSelection:a})):null};AddSourceWizard.propTypes={afterSuccess:PropTypes.func,sourceTypes:PropTypes.arrayOf(PropTypes.shape({id:PropTypes.string.isRequired,name:PropTypes.string.isRequired,product_name:PropTypes.string.isRequired,schema:PropTypes.shape({authentication:PropTypes.array,endpoint:PropTypes.object})})),applicationTypes:PropTypes.arrayOf(PropTypes.shape({id:PropTypes.string.isRequired,name:PropTypes.string.isRequired,display_name:PropTypes.string.isRequired})),onClose:PropTypes.func.isRequired,isOpen:PropTypes.bool.isRequired,successfulMessage:PropTypes.node,initialValues:PropTypes.shape(defineProperty._defineProperty({},PropTypes.string,PropTypes.oneOf([PropTypes.string,PropTypes.array,PropTypes.number,PropTypes.bool]))),disableAppSelection:PropTypes.bool,hideSourcesButton:PropTypes.bool,returnButtonTitle:PropTypes.node},AddSourceWizard.defaultProps={successfulMessage:React__default.createElement(reactIntl.FormattedMessage,{id:"wizard.successfulMessage",defaultMessage:"Your source was successfully added."}),initialValues:{},returnButtonTitle:React__default.createElement(reactIntl.FormattedMessage,{id:"wizard.goBackToSources",defaultMessage:"Go back to Sources"})};var AddSourceButton=function AddSourceButton(e){var r=React.useState(!1),t=slicedToArray._slicedToArray(r,2),s=t[0],o=t[1];return(React__default.createElement(React__default.Fragment,null,React__default.createElement(Button_js.Button,{variant:"primary",onClick:function onClick(){return o(!0)}},hardcodedSchemas.WIZARD_TITLE),React__default.createElement(AddSourceWizard,sourceFormRenderer._extends({isOpen:s,onClose:function onClose(){return o(!1)}},e))))};exports.AddSourceButton=AddSourceButton,exports.AddSourceWizard=AddSourceWizard;
